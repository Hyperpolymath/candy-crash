<% content_for :title, "Student Dashboard" %>

<div class="container py-4">
  <!-- Welcome Header -->
  <div class="row mb-4">
    <div class="col-12">
      <h1 class="display-5 fw-bold">Welcome back, <%= current_user.profile.first_name || 'Student' %>! ðŸ‘‹</h1>
      <p class="lead text-muted">Track your learning progress and achievements</p>
    </div>
  </div>

  <!-- Stats Cards (Game-like Metrics) -->
  <div class="row g-4 mb-5">
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 bg-primary bg-gradient text-white">
        <div class="card-body text-center">
          <i class="bi bi-book-fill" style="font-size: 3rem; opacity: 0.8;"></i>
          <h2 class="mt-3 mb-0"><%= @enrollments.count %></h2>
          <p class="mb-0">Active Courses</p>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 bg-success bg-gradient text-white">
        <div class="card-body text-center">
          <i class="bi bi-check-circle-fill" style="font-size: 3rem; opacity: 0.8;"></i>
          <h2 class="mt-3 mb-0"><%= @total_completed_lessons %></h2>
          <p class="mb-0">Lessons Completed</p>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 bg-warning bg-gradient text-white">
        <div class="card-body text-center">
          <i class="bi bi-trophy-fill" style="font-size: 3rem; opacity: 0.8;"></i>
          <h2 class="mt-3 mb-0"><%= @total_points %></h2>
          <p class="mb-0">Total Points</p>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100 bg-info bg-gradient text-white">
        <div class="card-body text-center">
          <i class="bi bi-award-fill" style="font-size: 3rem; opacity: 0.8;"></i>
          <h2 class="mt-3 mb-0"><%= @achievements.count %></h2>
          <p class="mb-0">Achievements</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Achievements Section (Game Badges) -->
  <% if @achievements.any? %>
    <div class="row mb-5">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3><i class="bi bi-trophy text-warning"></i> Your Achievements</h3>
        </div>
        <div class="row g-3">
          <% @achievements.each do |achievement| %>
            <div class="col-md-2">
              <div class="card border-0 shadow-sm h-100 text-center">
                <div class="card-body p-3">
                  <% badge_color = case achievement.badge_type
                                   when 'bronze' then 'text-secondary'
                                   when 'silver' then 'text-muted'
                                   when 'gold' then 'text-warning'
                                   when 'platinum' then 'text-info'
                                   else 'text-primary'
                                   end %>
                  <i class="bi bi-award-fill <%= badge_color %>" style="font-size: 3rem;"></i>
                  <h6 class="mt-2 mb-1 small fw-bold"><%= achievement.title %></h6>
                  <p class="text-muted small mb-1"><%= achievement.description %></p>
                  <span class="badge bg-success small">+<%= achievement.points %> pts</span>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <div class="row">
    <!-- My Courses (Left Column) -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-0 py-3">
          <h4 class="mb-0"><i class="bi bi-book"></i> My Courses</h4>
        </div>
        <div class="card-body">
          <% if @enrollments.any? %>
            <div class="list-group list-group-flush">
              <% @enrollments.each do |enrollment| %>
                <div class="list-group-item px-0">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1">
                      <h5 class="mb-1">
                        <%= link_to enrollment.course.title, course_path(enrollment.course), class: "text-decoration-none" %>
                      </h5>
                      <p class="text-muted small mb-2">
                        <i class="bi bi-person"></i> <%= enrollment.course.instructor.full_name %>
                        <span class="ms-2"><i class="bi bi-clock"></i> <%= enrollment.course.duration_hours %> hours</span>
                      </p>
                    </div>
                    <span class="badge bg-primary rounded-pill"><%= enrollment.course.level.capitalize %></span>
                  </div>

                  <!-- Progress Bar (Game-like Visual Feedback) -->
                  <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                      <small class="text-muted">Progress</small>
                      <small class="fw-bold text-primary"><%= enrollment.progress.to_i %>%</small>
                    </div>
                    <div class="progress" style="height: 8px;">
                      <div class="progress-bar bg-success" role="progressbar"
                           style="width: <%= enrollment.progress %>%;"
                           aria-valuenow="<%= enrollment.progress %>"
                           aria-valuemin="0"
                           aria-valuemax="100">
                      </div>
                    </div>
                  </div>

                  <div class="d-flex gap-2">
                    <%= link_to "Continue Learning", course_path(enrollment.course), class: "btn btn-sm btn-primary" %>
                    <% if enrollment.course.quizzes.published.any? %>
                      <%= link_to "Take Quiz", course_quiz_path(enrollment.course, enrollment.course.quizzes.published.first), class: "btn btn-sm btn-outline-secondary" %>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center py-5">
              <i class="bi bi-book text-muted" style="font-size: 4rem; opacity: 0.3;"></i>
              <p class="text-muted mt-3">You haven't enrolled in any courses yet.</p>
              <%= link_to "Browse Courses", courses_path, class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Recent Quiz Attempts (Right Column - Leaderboard Style) -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-0 py-3">
          <h5 class="mb-0"><i class="bi bi-graph-up"></i> Recent Quiz Results</h5>
        </div>
        <div class="card-body">
          <% if @recent_attempts.any? %>
            <div class="list-group list-group-flush">
              <% @recent_attempts.each do |attempt| %>
                <div class="list-group-item px-0 py-3">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <h6 class="mb-1"><%= attempt.quiz.title %></h6>
                      <small class="text-muted">
                        <%= time_ago_in_words(attempt.created_at) %> ago
                      </small>
                    </div>
                    <div class="text-end">
                      <% if attempt.completed? %>
                        <% score_class = attempt.score >= attempt.quiz.passing_score ? 'success' : 'danger' %>
                        <span class="badge bg-<%= score_class %> rounded-pill mb-1">
                          <%= attempt.score.to_i %>%
                        </span>
                        <br>
                        <% if attempt.score >= attempt.quiz.passing_score %>
                          <small class="text-success"><i class="bi bi-check-circle-fill"></i> Passed</small>
                        <% else %>
                          <small class="text-danger"><i class="bi bi-x-circle-fill"></i> Failed</small>
                        <% end %>
                      <% else %>
                        <span class="badge bg-warning">In Progress</span>
                      <% end %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <div class="text-center py-4">
              <i class="bi bi-clipboard-check text-muted" style="font-size: 3rem; opacity: 0.3;"></i>
              <p class="text-muted small mt-2">No quiz attempts yet</p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Quick Stats Card -->
      <div class="card border-0 shadow-sm bg-light">
        <div class="card-body">
          <h6 class="text-muted text-uppercase small mb-3">Your Stats</h6>
          <div class="d-flex justify-content-between mb-2">
            <span class="small">Quizzes Passed:</span>
            <strong class="text-success"><%= @total_quizzes_passed %></strong>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span class="small">Lessons Completed:</span>
            <strong class="text-primary"><%= @total_completed_lessons %></strong>
          </div>
          <div class="d-flex justify-content-between">
            <span class="small">Achievement Points:</span>
            <strong class="text-warning"><%= @total_points %></strong>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
