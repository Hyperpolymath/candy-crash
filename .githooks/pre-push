#!/usr/bin/env bash
# SPDX-License-Identifier: GPL-3.0-or-later
#
# Git pre-push hook for Candy Crash
# Runs comprehensive tests and security checks before allowing push
#
# Installation:
#   git config core.hooksPath .githooks
#   chmod +x .githooks/pre-push

set -e  # Exit on error

echo "ðŸš€ Running pre-push checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if running in CI (skip hooks in CI)
if [ -n "$CI" ]; then
    echo "âš ï¸  Running in CI, skipping pre-push hooks"
    exit 0
fi

# Function to print colored output
print_success() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_error() {
    echo -e "${RED}âœ—${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}âš ${NC} $1"
}

# Get remote and branch being pushed to
while read local_ref local_sha remote_ref remote_sha
do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # Branch deletion, skip checks
        print_warning "Deleting remote branch, skipping checks"
        exit 0
    fi

    # Check if pushing to main/master
    if [[ "$remote_ref" =~ refs/heads/(main|master) ]]; then
        print_warning "Pushing to $remote_ref - ensure you have approval!"
        read -p "Are you sure? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_error "Push to main/master aborted by user"
            exit 1
        fi
    fi
done

# 1. Run RSpec test suite
echo "ðŸ§ª Running RSpec tests..."
if command -v rspec &> /dev/null; then
    if bundle exec rspec --format progress; then
        print_success "All tests passed"
    else
        print_error "Tests failed"
        echo ""
        echo "Fix failing tests before pushing"
        exit 1
    fi
else
    print_warning "RSpec not installed, skipping tests"
fi

# 2. Run Brakeman security scanner
echo "ðŸ”’ Running Brakeman security scan..."
if command -v brakeman &> /dev/null; then
    if bundle exec brakeman --quiet --no-pager --exit-on-warn; then
        print_success "No security warnings found"
    else
        print_error "Security warnings detected"
        echo ""
        echo "Review and fix security issues before pushing"
        exit 1
    fi
else
    print_warning "Brakeman not installed, skipping security scan"
fi

# 3. Run Bundler Audit for vulnerable dependencies
echo "ðŸ“¦ Checking for vulnerable dependencies..."
if command -v bundle-audit &> /dev/null; then
    if bundle audit check; then
        print_success "No vulnerable dependencies"
    else
        print_error "Vulnerable dependencies detected"
        echo ""
        echo "Update vulnerable gems before pushing"
        exit 1
    fi
else
    print_warning "Bundler Audit not installed, skipping dependency check"
fi

# 4. Check for untracked migrations
echo "ðŸ—„ï¸  Checking for pending migrations..."
if [ -d "db/migrate" ]; then
    pending=$(bundle exec rails db:migrate:status 2>/dev/null | grep "down" || true)
    if [ -n "$pending" ]; then
        print_warning "Pending migrations detected:"
        echo "$pending"
        read -p "Push anyway? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_error "Push aborted - run migrations first"
            exit 1
        fi
    else
        print_success "No pending migrations"
    fi
fi

# 5. Check for large commits
echo "ðŸ“ Checking commit sizes..."
commit_count=$(git log @{u}.. --oneline 2>/dev/null | wc -l || echo "0")
if [ "$commit_count" -gt 20 ]; then
    print_warning "Large number of commits ($commit_count)"
    echo "Consider squashing commits before pushing"
fi

# 6. Verify SPDX headers in all committed files
echo "ðŸ“ Verifying SPDX headers..."
if command -v just &> /dev/null; then
    if just audit-licence &>/dev/null; then
        print_success "All source files have SPDX headers"
    else
        print_warning "Some files missing SPDX headers (not blocking)"
    fi
fi

# Success!
echo ""
print_success "All pre-push checks passed! ðŸš€"
echo "Safe to push to remote"
echo ""

exit 0
